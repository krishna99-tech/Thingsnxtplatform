version: '3.8'

services:
  # FastAPI Backend Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: thingsnxt-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    extra_hosts:
      # Allow connection to host machine's MongoDB
      - "host.docker.internal:host-gateway"
    environment:
      # MongoDB Connection - External MongoDB
      # Option 1: Connect to MongoDB on host machine
      - MONGO_URI=${MONGO_URI:-mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-changeme}@host.docker.internal:27017/${MONGO_DB_NAME:-iot_auth_db}?authSource=admin}
      # Option 2: Connect to remote MongoDB (uncomment and set MONGO_URI in .env)
      # - MONGO_URI=${MONGO_URI}
      - MONGO_DB_NAME=${MONGO_DB_NAME:-iot_auth_db}
      # JWT Configuration
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - RESET_TOKEN_EXPIRE_HOURS=${RESET_TOKEN_EXPIRE_HOURS:-2}
      # Application Configuration
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - OFFLINE_TIMEOUT=${OFFLINE_TIMEOUT:-20}
      # Email Configuration (optional)
      - EMAIL_HOST=${EMAIL_HOST:-smtp.gmail.com}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USER=${EMAIL_USER:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_FROM=${EMAIL_FROM:-}
      - APP_NAME=${APP_NAME:-ThingsNXT IoT Platform}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - COMPANY_NAME=${COMPANY_NAME:-ThingsNXT}
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      # Mount templates directory if needed
      - ./templates:/app/templates:ro
      # Optional: Mount logs directory
      - ./logs:/app/logs

networks:
  app-network:
    driver: bridge